# auth-service

`auth-service` - 

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å Keycloak –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –£–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–ø—Ä–æ—Ñ–∏–ª—å, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ —Ç.–¥.)
- –•—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ PostgreSQL (ksb_auth_db)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Flyway –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç REST API
- –ü–æ–∫—Ä—ã—Ç —Ç–µ—Å—Ç–∞–º–∏
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
keycloak-admin-client, kotlinx.serialization

- Ktor Server (core, auth, content-negotiation, etc.)
- Kotlinx Serialization
- Exposed (–∏–ª–∏ –¥—Ä—É–≥–∞—è ORM/–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –ë–î)
- HikariCP (–ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π)
- Flyway
- PostgreSQL JDBC
- Koin (DI)
- Logback
- Test containers (–¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤)
- Kotlin Test

## TODO

### üåê 4. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è API

- [ ] –°–æ–∑–¥–∞—Ç—å —Ä–æ—É—Ç—ã:
    - `GET /api/v1/users/me` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–∑ JWT –∏ –ë–î)
    - `POST /api/v1/users/register` ‚Üí —Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î (–∏, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –≤ Keycloak)
    - `PUT /api/v1/users/me` ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å
    - `GET /api/v1/health` ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ `kotlinx.validation` –∏–ª–∏ –≤—Ä—É—á–Ω—É—é)
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
    - [ ] –°–æ–∑–¥–∞—Ç—å `ExceptionHandler` (—Å –ø–æ–º–æ—â—å—é `StatusPages`)
    - [ ] –í–æ–∑–≤—Ä–∞—â–∞—Ç—å `400`, `401`, `403`, `404`, `500` —Å JSON-—Ç–µ–ª–æ–º
- [ ] –î–æ–±–∞–≤–∏—Ç—å OpenAPI/Swagger (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ `ktor-swagger` –∏–ª–∏ `kotlinx-serialization` + —Ä—É—á–Ω–æ–π JSON)

---

### üß™ 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- [ ] Unit-—Ç–µ—Å—Ç—ã:
    - [ ] –°–µ—Ä–≤–∏—Å—ã, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –º–∞–ø–ø–µ—Ä—ã
    - [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `MockK` –¥–ª—è –º–æ–∫–æ–≤
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:
    - [ ] –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î —á–µ—Ä–µ–∑ `TestContainers`
    - [ ] –¢–µ—Å—Ç—ã –¥–ª—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ (—Å `ktor-server-test-host`)
    - [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞:
        - –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        - –í–∞–ª–∏–¥–∞—Ü–∏—è JWT
        - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π Flyway
- [ ] –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ > 70% (–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å JaCoCo)

---

### üß± 6. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø—ã Clean Architecture (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ):
    - `domain`, `application`, `infrastructure`, `presentation`
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Dependency Injection (Koin):
    - [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–¥—É–ª–∏: `databaseModule`, `routingModule`, `authModule`
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
    - [ ] –î–æ–±–∞–≤–∏—Ç—å MDC (–¥–ª—è —Ç—Ä–µ–π—Å–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤)
    - [ ] –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏ –æ—à–∏–±–∫–∏
- [ ] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
    - [ ] –†–∞–∑–¥–µ–ª–∏—Ç—å `application.conf` –Ω–∞ `dev`, `test`, `prod` (—á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ–∏–ª–∏)
- [ ] –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
    - [ ] CORS
    - [ ] Rate limiting (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    - [ ] –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ `ktor-freemarker` –∏–ª–∏ —Ä—É—á–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏)

---

### üîÑ 8. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å notification-service (–Ω–∞ –±—É–¥—É—â–µ–µ)

- [ ] –ü–æ–¥—É–º–∞—Ç—å –æ —Å–ø–æ—Å–æ–±–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:
    - [ ] REST API –≤—ã–∑–æ–≤
    - [ ] –ò–ª–∏ –æ—á–µ—Ä–µ–¥—å (Kafka/RabbitMQ ‚Äî –ø–æ–∑–∂–µ)
- [ ] –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å –≤ `notification-service` –Ω–∞ `POST /api/v1/emails`
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Ktor Client` –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Keycloak + Ktor –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è](https://ktor.io/docs/jwt.html)
- [Flyway —Å Kotlin](https://flywaydb.org/documentation/usage/api/)
- [Exposed ORM Guide](https://github.com/JetBrains/Exposed)
- [TestContainers –¥–ª—è Kotlin](https://www.testcontainers.org/modules/databases/postgresql/)
- [Ktor + Docker](https://ktor.io/docs/docker.html)

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Keycloak

1. –°–æ–∑–¥–∞—Ç—å Realm
2. –°–æ–∑–¥–∞—Ç—å Client

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞**

| –ü–∞—Ä–∞–º–µ—Ç—Ä                | –û–ø–∏—Å–∞–Ω–∏–µ                                           | –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ                               |
|-------------------------|----------------------------------------------------|--------------------------------------------------------|
| Client ID               | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Ä–∞–º–∫–∞—Ö Realm    | –õ—é–±–æ–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è (–Ω–∞–ø—Ä. my-web-app, mobile-client) |
| Client Protocol         | –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏               | openid-connect (–¥–ª—è OAuth2/OIDC)                       |
| Client Authentication   | –¢—Ä–µ–±–æ–≤–∞—Ç—å –ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∫–ª–∏–µ–Ω—Ç–∞                | On –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, Off –¥–ª—è SPA/–º–æ–±–∏–ª—å–Ω—ã—Ö     |
| Authorization           | –í–∫–ª—é—á–∏—Ç—å —Å–µ—Ä–≤–∏—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (UMA)                  | Off (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–æ–ª–∏—Ç–∏–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)        |
| Authentication Flows    | –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏                    | Standard flow + Direct access grants (–¥–ª—è API)         |
| PKCE Method             | –ú–µ—Ç–æ–¥ –∑–∞—â–∏—Ç—ã Code Exchange                         | S256 (–¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤)                          |
| Root URL	               | –ë–∞–∑–æ–≤—ã–π URL –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è                 | –ü–æ–ª–Ω—ã–π URL (–Ω–∞–ø—Ä. https://app.example.com)             |
| Valid Redirect URIs     | –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ URI –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ | –¢–æ—á–Ω—ã–µ URI (–Ω–∞–ø—Ä. https://app.example.com/callback)    |
| Web Origins             | –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã –¥–ª—è CORS                        | –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã (–Ω–∞–ø—Ä. https://app.example.com)      |
| Always Display in UI    | –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –≤—Ö–æ–¥–∞              | Off (–µ—Å–ª–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–±–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞)                  |
| Consent Required        | –¢—Ä–µ–±–æ–≤–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                    | Off (–¥–ª—è –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π)                        |
| Login Theme             | –¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞ –≤—Ö–æ–¥–∞	                      | –ü—É—Å—Ç–æ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–º–∞ Realm)                        | 

3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å *Client Secret*
4. –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
