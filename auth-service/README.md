# auth-service

`auth-service` - 

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å Keycloak –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –£–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–ø—Ä–æ—Ñ–∏–ª—å, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ —Ç.–¥.)
- –•—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ PostgreSQL (ksb_auth_db)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Flyway –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç REST API
- –ü–æ–∫—Ä—ã—Ç —Ç–µ—Å—Ç–∞–º–∏
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
keycloak-admin-client, kotlinx.serialization

- Ktor Server (core, auth, content-negotiation, etc.)
- Kotlinx Serialization
- Exposed (–∏–ª–∏ –¥—Ä—É–≥–∞—è ORM/–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –ë–î)
- HikariCP (–ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π)
- Flyway
- PostgreSQL JDBC
- Koin (DI)
- Logback
- Test containers (–¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤)
- Kotlin Test

## TODO

## üõ†Ô∏è 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

- [ ] –°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å `auth-service` –≤ `kotlin-sandbox`
- [ ] –î–æ–±–∞–≤–∏—Ç—å `build.gradle.kts` —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏:
    
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `application.conf` (HOCON) –¥–ª—è:
    - –ü–æ—Ä—Ç (9001)
    - –ë–î (host, port, user, password, db name)
    - Keycloak (auth server URL, realm, client ID)
    - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `Dockerfile` –¥–ª—è `auth-service`
- [ ] –î–æ–±–∞–≤–∏—Ç—å `docker-compose.yml` (—É–∂–µ –µ—Å—Ç—å –ë–î, –¥–æ–±–∞–≤–∏—Ç—å Keycloak –∏ MailHog)

---

## üîê 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Keycloak

- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å Keycloak —á–µ—Ä–µ–∑ Docker (–≤ `docker-compose.yml`)
    - [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–¥–º–∏–Ω-–∫–æ–Ω—Å–æ–ª—å (–ø–æ—Ä—Ç 8080)
    - [ ] –°–æ–∑–¥–∞—Ç—å realm: `ksb-realm`
    - [ ] –°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç: `auth-service-client` (—Å —Ç–∏–ø–æ–º `confidential`)
    - [ ] –í–∫–ª—é—á–∏—Ç—å `Direct Access Grants` –∏ `Service Accounts`
    - [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `Valid Redirect URIs` –∏ `Web Origins`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é JWT –≤ Ktor:
    - [ ] –î–æ–±–∞–≤–∏—Ç—å `install(Authentication)`
    - [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `jwt { }` —Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π —Ç–æ–∫–µ–Ω–∞ –æ—Ç Keycloak
    - [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `verifier` —Å –ø–æ–º–æ—â—å—é `jwkProvider` (–ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –∏–∑ `.well-known/openid-configuration`)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç `/auth/token` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –ø—Ä–æ–∫—Å–∏-–¥–æ—Å—Ç—É–ø)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–æ–ª–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, `@RequiresRole("user")` —á–µ—Ä–µ–∑ Ktor features)

---

## üóÑÔ∏è 3. –†–∞–±–æ—Ç–∞ —Å PostgreSQL –∏ Flyway

- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ `ksb_auth_db` —á–µ—Ä–µ–∑ Hikari
- [ ] –î–æ–±–∞–≤–∏—Ç—å Flyway:
    - [ ] –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É `src/main/resources/db/migration`
    - [ ] –ù–∞–ø–∏—Å–∞—Ç—å `V1__create_users_table.sql`:
      ```sql
      CREATE TABLE users (
          id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
          username VARCHAR(255) UNIQUE NOT NULL,
          email VARCHAR(255) UNIQUE NOT NULL,
          first_name VARCHAR(255),
          last_name VARCHAR(255),
          created_at TIMESTAMP DEFAULT NOW(),
          updated_at TIMESTAMP DEFAULT NOW()
      );
      ```
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- [ ] –°–æ–∑–¥–∞—Ç—å —Å—É—â–Ω–æ—Å—Ç—å `User` (data class)
- [ ] –°–æ–∑–¥–∞—Ç—å DAO/Repository –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (—á–µ—Ä–µ–∑ Exposed –∏–ª–∏ raw JDBC)

---

## üåê 4. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è API

- [ ] –°–æ–∑–¥–∞—Ç—å —Ä–æ—É—Ç—ã:
    - `GET /api/v1/users/me` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–∑ JWT –∏ –ë–î)
    - `POST /api/v1/users/register` ‚Üí —Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î (–∏, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –≤ Keycloak)
    - `PUT /api/v1/users/me` ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å
    - `GET /api/v1/health` ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ `kotlinx.validation` –∏–ª–∏ –≤—Ä—É—á–Ω—É—é)
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
    - [ ] –°–æ–∑–¥–∞—Ç—å `ExceptionHandler` (—Å –ø–æ–º–æ—â—å—é `StatusPages`)
    - [ ] –í–æ–∑–≤—Ä–∞—â–∞—Ç—å `400`, `401`, `403`, `404`, `500` —Å JSON-—Ç–µ–ª–æ–º
- [ ] –î–æ–±–∞–≤–∏—Ç—å OpenAPI/Swagger (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ `ktor-swagger` –∏–ª–∏ `kotlinx-serialization` + —Ä—É—á–Ω–æ–π JSON)

---

## üß™ 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- [ ] Unit-—Ç–µ—Å—Ç—ã:
    - [ ] –°–µ—Ä–≤–∏—Å—ã, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –º–∞–ø–ø–µ—Ä—ã
    - [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `MockK` –¥–ª—è –º–æ–∫–æ–≤
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:
    - [ ] –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î —á–µ—Ä–µ–∑ `TestContainers`
    - [ ] –¢–µ—Å—Ç—ã –¥–ª—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ (—Å `ktor-server-test-host`)
    - [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞:
        - –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        - –í–∞–ª–∏–¥–∞—Ü–∏—è JWT
        - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π Flyway
- [ ] –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ > 70% (–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å JaCoCo)

---

## üß± 6. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø—ã Clean Architecture (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ):
    - `domain`, `application`, `infrastructure`, `presentation`
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Dependency Injection (Koin):
    - [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–¥—É–ª–∏: `databaseModule`, `routingModule`, `authModule`
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
    - [ ] –î–æ–±–∞–≤–∏—Ç—å MDC (–¥–ª—è —Ç—Ä–µ–π—Å–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤)
    - [ ] –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏ –æ—à–∏–±–∫–∏
- [ ] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
    - [ ] –†–∞–∑–¥–µ–ª–∏—Ç—å `application.conf` –Ω–∞ `dev`, `test`, `prod` (—á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ–∏–ª–∏)
- [ ] –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
    - [ ] CORS
    - [ ] Rate limiting (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    - [ ] –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ `ktor-freemarker` –∏–ª–∏ —Ä—É—á–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏)

---

## üì¶ 7. Docker –∏ CI/CD (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `Dockerfile` –¥–ª—è `auth-service`
- [ ] –î–æ–±–∞–≤–∏—Ç—å `auth-service` –≤ `docker-compose.yml`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–µ—Ä–≤–∏—Å —Å—Ç–∞—Ä—Ç—É–µ—Ç –∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –ë–î –∏ Keycloak
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `.github/workflows` (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å GitHub):
    - [ ] –°–±–æ—Ä–∫–∞
    - [ ] –¢–µ—Å—Ç—ã
    - [ ] –õ–∏–Ω—Ç–∏–Ω–≥ (ktlint)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `ktlint` –∏ `detekt` –≤ –ø—Ä–æ–µ–∫—Ç–µ

---

## üîÑ 8. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å notification-service (–Ω–∞ –±—É–¥—É—â–µ–µ)

- [ ] –ü–æ–¥—É–º–∞—Ç—å –æ —Å–ø–æ—Å–æ–±–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:
    - [ ] REST API –≤—ã–∑–æ–≤
    - [ ] –ò–ª–∏ –æ—á–µ—Ä–µ–¥—å (Kafka/RabbitMQ ‚Äî –ø–æ–∑–∂–µ)
- [ ] –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å –≤ `notification-service` –Ω–∞ `POST /api/v1/emails`
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Ktor Client` –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤

---

## ‚úÖ 9. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫

- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å `docker-compose up` ‚Äî –¥–æ–ª–∂–Ω—ã —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å:
    - `ksb_auth_db`
    - `keycloak`
    - `auth-service`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
    - [ ] –î–æ—Å—Ç—É–ø –∫ Keycloak Admin Console
    - [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ Flyway –ø—Ä–æ—à–ª–∏
    - [ ] –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç (—á–µ—Ä–µ–∑ curl –∏–ª–∏ Postman)
    - [ ] JWT —Ç–æ–∫–µ–Ω –∏–∑ Keycloak –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é
    - [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Keycloak + Ktor –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è](https://ktor.io/docs/jwt.html)
- [Flyway —Å Kotlin](https://flywaydb.org/documentation/usage/api/)
- [Exposed ORM Guide](https://github.com/JetBrains/Exposed)
- [TestContainers –¥–ª—è Kotlin](https://www.testcontainers.org/modules/databases/postgresql/)
- [Ktor + Docker](https://ktor.io/docs/docker.html)

---

> ‚úÖ **–°–æ–≤–µ—Ç**: –î–µ–ª–∞–π –ø–æ –æ–¥–Ω–æ–º—É –ø—É–Ω–∫—Ç—É –≤ –¥–µ–Ω—å. –°–Ω–∞—á–∞–ª–∞ ‚Äî –±–∞–∑–∞ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏, –ø–æ—Ç–æ–º Keycloak, –ø–æ—Ç–æ–º API. –ü–∏—à–∏ —Ç–µ—Å—Ç—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.

–ö–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—à—å `auth-service`, –ø–µ—Ä–µ–π–¥—ë–º –∫ `notification-service` —Å MailHog –∏ —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –ø–∏—Å—å–º–∞–º–∏.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –º–æ–≥—É –ø–æ–º–æ—á—å —Å `docker-compose.yml` –∏–ª–∏ –ø–µ—Ä–≤—ã–º –º–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º —Å–∫—Ä–∏–ø—Ç–æ–º.
